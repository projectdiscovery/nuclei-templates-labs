FROM debian:12

RUN apt update && apt -y install libapr1-dev libaprutil1-dev libpcre3-dev \
    wget vim gcc iproute2 procps make zlib1g-dev uwsgi uwsgi-plugin-python3 bind9-host

WORKDIR /root
COPY --chmod=755 scripts/ .
RUN wget https://archive.apache.org/dist/httpd/httpd-2.4.32.tar.gz && \
    tar -xvf httpd-2.4.32.tar.gz && \
    cd httpd-2.4.32 && \
    ./configure --prefix=/usr/local/apache2 --enable-mods-shared=all \
    --enable-deflate --enable-proxy --enable-proxy-balancer --enable-proxy-http && \
    make -j4 && \
    make install && \
    sed -i '/LoadModule proxy_module modules\/mod_proxy\.so/s/^#//g' /usr/local/apache2/conf/httpd.conf && \
    sed -i '/LoadModule proxy_uwsgi_module modules\/mod_proxy_uwsgi\.so/s/^#//g' /usr/local/apache2/conf/httpd.conf && \
    cp /usr/local/apache2/bin/apachectl /etc/init.d/apache2 && \
    printf '\n\
    <VirtualHost *:80>\n\
        ProxyPass "/" "uwsgi://127.0.0.1:8080/"\n\
        LimitRequestFieldSize 1048576\n\
    </VirtualHost>\n\
    ' >> /usr/local/apache2/conf/httpd.conf && \
    chmod +x /root/startup.sh

ENTRYPOINT ["/root/startup.sh"]
    
